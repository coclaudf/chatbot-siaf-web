<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asistente SIAF</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; background: #f7f7f7; display: flex; justify-content: center; align-items: center; height: 100vh; }
        #chat-container { width: 100%; max-width: 600px; height: 80vh; max-height: 700px; border: 1px solid #ddd; background: #fff; box-shadow: 0 4px 12px rgba(0,0,0,0.05); border-radius: 8px; overflow: hidden; display: flex; flex-direction: column; }
        #chat-header { background: #0056b3; color: white; padding: 15px 20px; font-weight: bold; border-bottom: 1px solid #004a99; }
        #chat-box { flex-grow: 1; overflow-y: auto; padding: 20px; }
        #input-area { display: flex; border-top: 1px solid #ddd; padding: 10px; background: #fcfcfc; }
        #user-input { flex-grow: 1; border: 1px solid #ccc; border-radius: 20px; padding: 10px 15px; font-size: 14px; outline: none; }
        #user-input:focus { border-color: #007bff; box-shadow: 0 0 0 2px rgba(0,123,255,0.2); }
        #send-button { background: #007bff; color: white; border: none; padding: 10px 18px; margin-left: 10px; border-radius: 20px; cursor: pointer; font-weight: bold; }
        #send-button:hover { background: #0056b3; }
        .message { margin-bottom: 15px; display: flex; }
        .message.user { justify-content: flex-end; }
        .message.bot { justify-content: flex-start; }
        /* ESTA ES LA REGLA QUE ARREGLA EL DESBORDAMIENTO */
        .message .content { padding: 10px 15px; border-radius: 18px; max-width: 85%; line-height: 1.4; white-space: pre-wrap; word-wrap: break-word; }
        .message.bot .content { background: #eee; color: #333; }
        .message.user .content { background: #007bff; color: white; }
        
        /* Contenedor para botones (sugerencias Y categor√≠as) */
        .botones-container { padding: 5px; background: #f9f9f9; border-radius: 10px; margin-top: 5px; }
        .boton-opcion { background: #fff; border: 1px solid #007bff; color: #007bff; padding: 8px 12px; border-radius: 15px; cursor: pointer; margin: 5px 3px; display: inline-block; font-size: 13px; transition: background 0.2s; }
        .boton-opcion:hover { background: #e6f2ff; }
        .boton-ia { background: #6c757d; border-color: #6c757d; color: white; } /* Bot√≥n para escalar a IA */
        .boton-ia:hover { background: #5a6268; }

        #spinner { text-align: center; padding: 10px; }
        .dot-flashing { position: relative; width: 6px; height: 6px; border-radius: 5px; background-color: #999; color: #999; animation: dotFlashing 1s infinite linear alternate; animation-delay: .5s; }
        .dot-flashing::before, .dot-flashing::after { content: ''; display: inline-block; position: absolute; top: 0; }
        .dot-flashing::before { left: -10px; width: 6px; height: 6px; border-radius: 5px; background-color: #999; color: #999; animation: dotFlashing 1s infinite alternate; animation-delay: 0s; }
        .dot-flashing::after { left: 10px; width: 6px; height: 6px; border-radius: 5px; background-color: #999; color: #999; animation: dotFlashing 1s infinite alternate; animation-delay: 1s; }
        @keyframes dotFlashing { 0% { background-color: #999; } 50%, 100% { background-color: #eee; } }
    </style>
</head>
<body>
    <div id="chat-container">
        <div id="chat-header">Asistente Virtual SIAF</div>
        <div id="chat-box">
            </div>
        <div id="input-area">
            <input type="text" id="user-input" placeholder="Escrib√≠ tu consulta...">
            <button id="send-button">Enviar</button>
        </div>
    </div>

    <script>
        const chatBox = document.getElementById('chat-box');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');

        // --- MANEJADORES DE EVENTOS PRINCIPALES ---

        // 1. Al cargar la p√°gina, pedir saludo y categor√≠as
        document.addEventListener('DOMContentLoaded', getInitialData);

        // 2. Al hacer clic en "Enviar" (B√∫squeda libre)
        sendButton.addEventListener('click', manejarEnvioUsuario);
        userInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                manejarEnvioUsuario();
            }
        });

        // --- L√ìGICA DE NAVEGACI√ìN POR CATEGOR√çAS ---

        async function getInitialData() {
            agregarSpinner(true);
            try {
                const response = await fetch('/get_initial_data');
                agregarSpinner(false);
                
                if (!response.ok) {
                    agregarMensaje('bot', '‚ö†Ô∏è Ocurri√≥ un error al cargar el bot. Intenta recargar la p√°gina.');
                    return;
                }
                const data = await response.json();
                
                // Muestra el saludo
                agregarMensaje('bot', data.saludo);
                
                // Muestra los botones de categor√≠a
                if (data.categorias && data.categorias.length > 0) {
                    mostrarBotones(data.categorias, 'categoria');
                }
                
            } catch (error) {
                agregarSpinner(false);
                console.error('Error:', error);
                agregarMensaje('bot', '‚ö†Ô∏è No pude conectarme al servidor.');
            }
        }

        async function manejarClickCategoria(categoria) {
            limpiarBotones();
            agregarMensaje('user', `Seleccion√©: ${categoria}`);
            agregarSpinner(true);

            try {
                const response = await fetch('/get_questions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ categoria: categoria })
                });
                agregarSpinner(false);

                if (!response.ok) {
                    agregarMensaje('bot', '‚ö†Ô∏è Ocurri√≥ un error al cargar las preguntas.');
                    return;
                }
                const data = await response.json();
                
                agregarMensaje('bot', 'Tengo estas preguntas sobre ese tema:');
                // Muestra los botones de preguntas
                mostrarBotones(data.preguntas, 'pregunta', data.categoria);

            } catch (error) {
                agregarSpinner(false);
                console.error('Error:', error);
                agregarMensaje('bot', '‚ö†Ô∏è Error de conexi√≥n al pedir preguntas.');
            }
        }

        async function manejarClickPregunta(categoria, pregunta) {
            limpiarBotones();
            agregarMensaje('user', pregunta);
            agregarSpinner(true);

            try {
                const response = await fetch('/get_answer', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ categoria: categoria, pregunta: pregunta })
                });
                agregarSpinner(false);
                
                if (!response.ok) {
                    agregarMensaje('bot', '‚ö†Ô∏è Ocurri√≥ un error al obtener la respuesta.');
                    return;
                }
                const data = await response.json();
                
                // Muestra la respuesta final del FAQ
                agregarMensaje('bot', data.respuesta);
                // Aqu√≠ termina este flujo. Podr√≠amos agregar un "¬øTe sirvi√≥?"

            } catch (error) {
                agregarSpinner(false);
                console.error('Error:', error);
                agregarMensaje('bot', '‚ö†Ô∏è Error de conexi√≥n al pedir la respuesta.');
            }
        }


        // --- L√ìGICA DE B√öSQUEDA LIBRE (Sugerencias e IA) ---

        async function manejarEnvioUsuario() {
            const consulta = userInput.value;
            if (!consulta.trim()) return;

            agregarMensaje('user', consulta);
            userInput.value = '';
            limpiarBotones(); // Limpia categor√≠as/preguntas si las hab√≠a
            
            userInput.disabled = true;
            sendButton.disabled = true;

            // Envia la consulta al endpoint /chat (el de sugerencias/IA)
            await enviarConsultaChat(consulta, 'sugerencias');

            userInput.disabled = false;
            sendButton.disabled = false;
            userInput.focus();
        }

        async function enviarConsultaChat(consulta, tipo) {
            agregarSpinner(true);
            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mensaje: consulta, tipo: tipo })
                });
                agregarSpinner(false);

                if (!response.ok) {
                    const errorData = await response.json();
                    agregarMensaje('bot', `‚ö†Ô∏è Ocurri√≥ un error: ${errorData.error || 'Por favor, intent√° de nuevo.'}`);
                    return;
                }
                const data = await response.json();

                if (data.tipo_respuesta === 'sugerencias') {
                    mostrarSugerencias(data.sugerencias, data.consulta_original);
                } else if (data.tipo_respuesta === 'ia') {
                    agregarMensaje('bot', data.respuesta, true); // true para que parsee newlines
                }

            } catch (error) {
                agregarSpinner(false);
                console.error('Error:', error);
                agregarMensaje('bot', '‚ö†Ô∏è No pude conectarme al servidor.');
            }
        }

        function mostrarSugerencias(sugerencias, consultaOriginal) {
            let botonesHTML = '<span>üîç ¬øQuiz√°s tu consulta se relaciona con alguna de estas preguntas?</span><br>';
            
            sugerencias.forEach(sug => {
                const respuestaEscapada = btoa(unescape(encodeURIComponent(sug.respuesta)));
                botonesHTML += `<div class='boton-opcion' onclick='manejarClickSugerencia(this, "${respuestaEscapada}")'>${sug.pregunta}</div>`;
            });

            const consultaEscapada = btoa(unescape(encodeURIComponent(consultaOriginal)));
            botonesHTML += `<div class='boton-opcion boton-ia' onclick='manejarClickIA(this, "${consultaEscapada}")'>Ninguna de las anteriores ‚Äì Preguntar a la IA</div>`;
            
            agregarBotones(botonesHTML);
        }

        function manejarClickSugerencia(elemento, respuestaBase64) {
            const respuesta = decodeURIComponent(escape(atob(respuestaBase64)));
            const pregunta = elemento.innerText;
            
            limpiarBotones();
            agregarMensaje('user', pregunta);
            agregarMensaje('bot', respuesta);
        }

        async function manejarClickIA(elemento, consultaBase64) {
            const consultaOriginal = decodeURIComponent(escape(atob(consultaBase64)));
            limpiarBotones();
            agregarMensaje('user', `(Reformulo mi consulta): ${consultaOriginal}`);
            
            userInput.disabled = true;
            sendButton.disabled = true;

            // Enviamos la consulta original a la IA
            await enviarConsultaChat(consultaOriginal, 'ia');

            userInput.disabled = false;
            sendButton.disabled = false;
            userInput.focus();
        }

        // --- FUNCIONES AUXILIARES DE LA INTERFAZ ---

        function mostrarBotones(lista, tipo, dataExtra = '') {
            let botonesHTML = '';
            if (tipo === 'categoria') {
                lista.forEach(item => {
                    botonesHTML += `<div class='boton-opcion' onclick='manejarClickCategoria("${item}")'>${item}</div>`;
                });
            } else if (tipo === 'pregunta') {
                lista.forEach(item => {
                    // Usamos comillas simples para el string de la pregunta
                    botonesHTML += `<div class='boton-opcion' onclick='manejarClickPregunta("${dataExtra}", "${item}")'>${item}</div>`;
                });
            }
            agregarBotones(botonesHTML);
        }

        function agregarBotones(html) {
            const msgDiv = document.createElement('div');
            msgDiv.className = 'message bot';
            const contentDiv = document.createElement('div');
            contentDiv.className = 'content botones-container';
            contentDiv.innerHTML = html;
            msgDiv.appendChild(contentDiv);
            chatBox.appendChild(msgDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function limpiarBotones() {
            const contenedores = document.querySelectorAll('.botones-container');
            contenedores.forEach(c => c.closest('.message.bot').remove());
        }

        function agregarMensaje(remitente, contenido, esHTML = false) {
            const msgDiv = document.createElement('div');
            msgDiv.className = `message ${remitente}`;
            const contentDiv = document.createElement('div');
            contentDiv.className = 'content';
            
            // ESTA ES LA MODIFICACI√ìN EST√âTICA (FIX #1)
            if (esHTML) {
                contentDiv.innerHTML = contenido;
            } else {
                contentDiv.textContent = contenido;
            }
            
            msgDiv.appendChild(contentDiv);
            chatBox.appendChild(msgDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
        }
        
        let spinnerElement = null;
        function agregarSpinner(mostrar) {
            if (mostrar) {
                if (!spinnerElement) {
                    spinnerElement = document.createElement('div');
                    spinnerElement.className = 'message bot';
                    spinnerElement.innerHTML = `<div class="content"><div id="spinner"><div class="dot-flashing"></div></div></div>`;
                    chatBox.appendChild(spinnerElement);
                    chatBox.scrollTop = chatBox.scrollHeight;
                }
            } else {
                if (spinnerElement) {
                    spinnerElement.remove();
                    spinnerElement = null;
                }
            }
        }
    </script>
</body>
</html>