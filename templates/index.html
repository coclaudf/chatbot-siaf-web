<<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asistente SIAF</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; background: #f7f7f7; display: flex; justify-content: center; align-items: center; height: 100vh; }
        #chat-container { width: 100%; max-width: 600px; height: 80vh; max-height: 700px; border: 1px solid #ddd; background: #fff; box-shadow: 0 4px 12px rgba(0,0,0,0.05); border-radius: 8px; overflow: hidden; display: flex; flex-direction: column; }
        #chat-header { background: #0056b3; color: white; padding: 15px 20px; font-weight: bold; border-bottom: 1px solid #004a99; }
        #chat-box { flex-grow: 1; overflow-y: auto; padding: 20px; }
        #input-area { display: flex; border-top: 1px solid #ddd; padding: 10px; background: #fcfcfc; }
        #user-input { flex-grow: 1; border: 1px solid #ccc; border-radius: 20px; padding: 10px 15px; font-size: 14px; outline: none; }
        #user-input:focus { border-color: #007bff; box-shadow: 0 0 0 2px rgba(0,123,255,0.2); }
        #send-button { background: #007bff; color: white; border: none; padding: 10px 18px; margin-left: 10px; border-radius: 20px; cursor: pointer; font-weight: bold; }
        #send-button:hover { background: #0056b3; }
        .message { margin-bottom: 15px; display: flex; }
        .message.user { justify-content: flex-end; }
        .message.bot { justify-content: flex-start; }
        .message .content { padding: 10px 15px; border-radius: 18px; max-width: 85%; line-height: 1.4; white-space: pre-wrap; word-wrap: break-word; }
        .message.bot .content { background: #eee; color: #333; }
        .message.user .content { background: #007bff; color: white; }
        
        /* Contenedor para botones */
        .botones-container { padding: 5px; background: #f9f9f9; border-radius: 10px; margin-top: 5px; }
        
        /* Botones de Contenido (Categor√≠as, Preguntas, Sugerencias) */
        .boton-opcion { background: #fff; border: 1px solid #007bff; color: #007bff; padding: 8px 12px; border-radius: 15px; cursor: pointer; margin: 5px; display: block; /* Apilados */ font-size: 13px; transition: background 0.2s; text-align: center; }
        .boton-opcion:hover { background: #e6f2ff; }
        
        /* Botones de Acci√≥n (Navegaci√≥n) */
        .boton-accion { margin-top: 10px; border-width: 2px; font-weight: bold; }
        .boton-accion.ia { background: #5a3ab2; border-color: #5a3ab2; color: white; } /* Realizar consulta IA */
        .boton-accion.ia:hover { background: #4a2f92; }
        .boton-accion.inicio { background: #28a745; border-color: #28a745; color: white; } /* Ir al inicio */
        .boton-accion.inicio:hover { background: #218838; }
        .boton-accion.atras { background: #ffc107; border-color: #ffc107; color: #333; } /* Volver atr√°s */
        .boton-accion.atras:hover { background: #e0a800; }
        .boton-accion.finalizar { background: #dc3545; border-color: #dc3545; color: white; } /* Finalizar */
        .boton-accion.finalizar:hover { background: #c82333; }


        #spinner { text-align: center; padding: 10px; }
        .dot-flashing { position: relative; width: 6px; height: 6px; border-radius: 5px; background-color: #999; color: #999; animation: dotFlashing 1s infinite linear alternate; animation-delay: .5s; }
        .dot-flashing::before, .dot-flashing::after { content: ''; display: inline-block; position: absolute; top: 0; }
        .dot-flashing::before { left: -10px; width: 6px; height: 6px; border-radius: 5px; background-color: #999; color: #999; animation: dotFlashing 1s infinite alternate; animation-delay: 0s; }
        .dot-flashing::after { left: 10px; width: 6px; height: 6px; border-radius: 5px; background-color: #999; color: #999; animation: dotFlashing 1s infinite alternate; animation-delay: 1s; }
        @keyframes dotFlashing { 0% { background-color: #999; } 50%, 100% { background-color: #eee; } }
    </style>
</head>
<body>
    <div id="chat-container">
        <div id="chat-header">Asistente Virtual SIAF</div>
        <div id="chat-box">
            </div>
        <div id="input-area">
            <input type="text" id="user-input" placeholder="Escrib√≠ tu consulta...">
            <button id="send-button">Enviar</button>
        </div>
    </div>

    <script>
        // --- CONSTANTES Y ESTADO GLOBAL ---
        const chatBox = document.getElementById('chat-box');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        // Flag para cumplir Req 2b: "Realizar consulta detallada"
        window.forceIA = false; 

        // --- MANEJADORES DE EVENTOS PRINCIPALES ---

        // 1. Al cargar la p√°gina, pedir saludo y categor√≠as
        document.addEventListener('DOMContentLoaded', getInitialData);

        // 2. Al hacer clic en "Enviar" (B√∫squeda libre)
        sendButton.addEventListener('click', manejarEnvioUsuario);
        userInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                manejarEnvioUsuario();
            }
        });

        // --- L√ìGICA DE NAVEGACI√ìN POR CATEGOR√çAS ---

        async function getInitialData() {
            agregarSpinner(true);
            try {
                const response = await fetch('/get_initial_data');
                agregarSpinner(false);
                
                if (!response.ok) {
                    agregarMensaje('bot', '‚ö†Ô∏è Ocurri√≥ un error al cargar el bot. Intenta recargar la p√°gina.');
                    return;
                }
                const data = await response.json();
                
                agregarMensaje('bot', data.saludo);
                
                if (data.categorias && data.categorias.length > 0) {
                    mostrarBotones(data.categorias, 'categoria');
                    // Req 1: Opci√≥n de finalizar (simplificada, aqu√≠ solo es escribir)
                    // Las opciones de finalizar se agregan en los siguientes pasos.
                }
                
            } catch (error) {
                agregarSpinner(false);
                console.error('Error:', error);
                agregarMensaje('bot', '‚ö†Ô∏è No pude conectarme al servidor.');
            }
        }

        async function manejarClickCategoria(categoria) {
            limpiarBotones();
            agregarMensaje('user', `Seleccion√©: ${categoria}`);
            agregarSpinner(true);

            try {
                const response = await fetch('/get_questions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ categoria: categoria })
                });
                agregarSpinner(false);

                if (!response.ok) {
                    agregarMensaje('bot', '‚ö†Ô∏è Ocurri√≥ un error al cargar las preguntas.');
                    return;
                }
                const data = await response.json();
                
                agregarMensaje('bot', 'Tengo estas preguntas sobre ese tema:');
                // Muestra los botones de preguntas
                mostrarBotones(data.preguntas, 'pregunta', data.categoria);
                
                // Req 2: A√±adir opciones de navegaci√≥n
                mostrarOpcionesNavegacion('lista_preguntas');

            } catch (error) {
                agregarSpinner(false);
                console.error('Error:', error);
                agregarMensaje('bot', '‚ö†Ô∏è Error de conexi√≥n al pedir preguntas.');
            }
        }

        async function manejarClickPregunta(categoria, pregunta) {
            limpiarBotones();
            // Limpiamos tambi√©n los botones de acci√≥n anteriores
            limpiarBotonesDeAccion(); 
            agregarMensaje('user', pregunta);
            agregarSpinner(true);

            try {
                const response = await fetch('/get_answer', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ categoria: categoria, pregunta: pregunta })
                });
                agregarSpinner(false);
                
                if (!response.ok) {
                    agregarMensaje('bot', '‚ö†Ô∏è Ocurri√≥ un error al obtener la respuesta.');
                    return;
                }
                const data = await response.json();
                
                agregarMensaje('bot', data.respuesta);
                
                // Req 3: A√±adir opciones post-respuesta
                mostrarOpcionesNavegacion('respuesta_faq', { categoria: categoria });

            } catch (error) {
                agregarSpinner(false);
                console.error('Error:', error);
                agregarMensaje('bot', '‚ö†Ô∏è Error de conexi√≥n al pedir la respuesta.');
            }
        }


        // --- L√ìGICA DE B√öSQUEDA LIBRE (Sugerencias e IA) ---

        async function manejarEnvioUsuario() {
            const consulta = userInput.value;
            if (!consulta.trim()) return;

            agregarMensaje('user', consulta);
            userInput.value = '';
            limpiarBotones(); // Limpia categor√≠as/preguntas
            limpiarBotonesDeAccion(); // Limpia botones de acci√≥n

            // Habilitar/Deshabilitar input
            userInput.disabled = true;
            sendButton.disabled = true;
            
            let tipoEnvio = 'sugerencias';
            // Req 2b: Si el usuario eligi√≥ "Consulta detallada", forzamos el tipo 'ia'
            if (window.forceIA === true) {
                tipoEnvio = 'ia';
                window.forceIA = false; // Reseteamos el flag
            }

            // Envia la consulta al endpoint /chat
            await enviarConsultaChat(consulta, tipoEnvio);

            // Reactivamos solo si la consulta no fue finalizada por la IA
            if (!userInput.disabled) {
                userInput.disabled = false;
                sendButton.disabled = false;
                userInput.focus();
            }
        }

        async function enviarConsultaChat(consulta, tipo) {
            agregarSpinner(true);
            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mensaje: consulta, tipo: tipo })
                });
                agregarSpinner(false);

                if (!response.ok) {
                    const errorData = await response.json();
                    agregarMensaje('bot', `‚ö†Ô∏è Ocurri√≥ un error: ${errorData.error || 'Por favor, intent√° de nuevo.'}`);
                    return;
                }
                const data = await response.json();

                if (data.tipo_respuesta === 'sugerencias') {
                    mostrarSugerencias(data.sugerencias, data.consulta_original);
                } else if (data.tipo_respuesta === 'ia') {
                    // Req 4: La IA responde y cierra la conversaci√≥n
                    agregarMensaje('bot', data.respuesta, true);
                    agregarMensaje('bot', 'Esta consulta ha finalizado. ¬°Gracias por usar el sistema! üëã');
                    
                    // Mostramos solo la opci√≥n de "nueva consulta"
                    mostrarOpcionesNavegacion('respuesta_ia');
                    
                    // Deshabilitamos permanentemente el input para este flujo
                    userInput.disabled = true;
                    sendButton.disabled = true;
                }

            } catch (error) {
                agregarSpinner(false);
                console.error('Error:', error);
                agregarMensaje('bot', '‚ö†Ô∏è No pude conectarme al servidor.');
            }
        }

        function mostrarSugerencias(sugerencias, consultaOriginal) {
            let botonesHTML = '<span>üîç ¬øQuiz√°s tu consulta se relaciona con alguna de estas preguntas?</span><br>';
            
            sugerencias.forEach(sug => {
                const respuestaEscapada = btoa(unescape(encodeURIComponent(sug.respuesta)));
                botonesHTML += `<div class='boton-opcion' onclick='manejarClickSugerencia(this, "${respuestaEscapada}")'>${sug.pregunta}</div>`;
            });
            
            agregarBotones(botonesHTML, 'botones-contenido');
            
            // A√±adimos las opciones de navegaci√≥n consistentes
            let opcionesHTML = '';
            const consultaEscapada = btoa(unescape(encodeURIComponent(consultaOriginal)));
            opcionesHTML += `<div class='boton-opcion boton-accion ia' onclick='manejarClickIA(this, "${consultaEscapada}")'>b) Ninguna de las anteriores ‚Äì Preguntar a la IA</div>`;
            opcionesHTML += `<div class='boton-opcion boton-accion inicio' onclick='irAlInicio()'>a) Ir al inicio</div>`;
            opcionesHTML += `<div class='boton-opcion boton-accion finalizar' onclick='finalizarConsulta()'>c) Finalizar consulta</div>`;

            agregarBotones(opcionesHTML, 'botones-accion');
        }

        function manejarClickSugerencia(elemento, respuestaBase64) {
            const respuesta = decodeURIComponent(escape(atob(respuestaBase64)));
            const pregunta = elemento.innerText;
            
            limpiarBotones();
            limpiarBotonesDeAccion();
            agregarMensaje('user', pregunta);
            agregarMensaje('bot', respuesta);
            
            // Req 3: A√±adimos opciones post-respuesta (pero sin "volver atr√°s" ya que no hay categor√≠a)
            mostrarOpcionesNavegacion('respuesta_faq_sugerencia');
        }

        async function manejarClickIA(elemento, consultaBase64) {
            const consultaOriginal = decodeURIComponent(escape(atob(consultaBase64)));
            limpiarBotones();
            limpiarBotonesDeAccion();
            agregarMensaje('user', `(Reformulo mi consulta): ${consultaOriginal}`);
            
            userInput.disabled = true;
            sendButton.disabled = true;

            // Enviamos la consulta original a la IA
            await enviarConsultaChat(consultaOriginal, 'ia');
        }

        // --- FUNCIONES DE NAVEGACI√ìN (Nuevas y Modificadas) ---

        function mostrarOpcionesNavegacion(estado, data = {}) {
            let botonesHTML = '';
            
            if (estado === 'lista_preguntas') { // Req 2
                botonesHTML += `<div class='boton-opcion boton-accion ia' onclick='prepararConsultaIA()'>b) Realizar consulta detallada</div>`;
                botonesHTML += `<div class='boton-opcion boton-accion inicio' onclick='irAlInicio()'>a) Ir al inicio</div>`;
                botonesHTML += `<div class='boton-opcion boton-accion finalizar' onclick='finalizarConsulta()'>c) Finalizar consulta</div>`;
            } 
            else if (estado === 'respuesta_faq') { // Req 3
                botonesHTML += `<div class='boton-opcion boton-accion atras' onclick='manejarClickCategoria("${data.categoria}")'>a) Volver atr√°s</div>`;
                botonesHTML += `<div class='boton-opcion boton-accion inicio' onclick='irAlInicio()'>b) Ir al inicio</div>`;
                botonesHTML += `<div class='boton-opcion boton-accion finalizar' onclick='finalizarConsulta()'>c) Finalizar consulta</div>`;
            }
            else if (estado === 'respuesta_faq_sugerencia') { // Mi adici√≥n (Req 3 pero desde sugerencia)
                botonesHTML += `<div class='boton-opcion boton-accion inicio' onclick='irAlInicio()'>Ir al inicio</div>`;
                botonesHTML += `<div class='boton-opcion boton-accion finalizar' onclick='finalizarConsulta()'>Finalizar consulta</div>`;
            }
            else if (estado === 'respuesta_ia') { // Req 4
                botonesHTML += `<div class='boton-opcion boton-accion inicio' onclick='irAlInicio()'>Comenzar una nueva consulta</div>`;
            }
            
            agregarBotones(botonesHTML, 'botones-accion');
        }
        
        // Req 2a, 3b
        function irAlInicio() {
            // La forma m√°s limpia de reiniciar el estado del chat
            location.reload(); 
        }

        // Req 2c, 3c
        function finalizarConsulta() {
            limpiarBotones();
            limpiarBotonesDeAccion();
            agregarMensaje('bot', 'Consulta finalizada. ¬°Gracias por usar el sistema! üëã');
            userInput.disabled = true;
            sendButton.disabled = true;
        }

        // Req 2b
        function prepararConsultaIA() {
            limpiarBotones();
            limpiarBotonesDeAccion();
            agregarMensaje('bot', 'Entendido. Escribe tu consulta con el mayor grado de detalle posible. Cuando est√©s listo, presiona Enviar.');
            window.forceIA = true; // Setea el flag
            userInput.focus();
        }

        // --- FUNCIONES AUXILIARES DE LA INTERFAZ ---

        function mostrarBotones(lista, tipo, dataExtra = '') {
            let botonesHTML = '';
            if (tipo === 'categoria') {
                lista.forEach(item => {
                    botonesHTML += `<div class='boton-opcion' onclick='manejarClickCategoria("${item}")'>${item}</div>`;
                });
            } else if (tipo === 'pregunta') {
                lista.forEach(item => {
                    // Escapamos comillas dentro de la pregunta por si acaso
                    const itemEscapado = item.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                    botonesHTML += `<div class='boton-opcion' onclick='manejarClickPregunta("${dataExtra}", "${itemEscapado}")'>${item}</div>`;
                });
            }
            agregarBotones(botonesHTML, 'botones-contenido');
        }

        function agregarBotones(html, tipoClase) {
            const msgDiv = document.createElement('div');
            msgDiv.className = 'message bot';
            const contentDiv = document.createElement('div');
            // 'tipoClase' nos permite diferenciar contenedores de contenido vs acci√≥n
            contentDiv.className = `content botones-container ${tipoClase || ''}`;
            contentDiv.innerHTML = html;
            msgDiv.appendChild(contentDiv);
            chatBox.appendChild(msgDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function limpiarBotones() {
            // Limpia botones de contenido (categor√≠as, preguntas, sugerencias)
            const contenedores = document.querySelectorAll('.botones-container:not(.botones-accion)');
            contenedores.forEach(c => c.closest('.message.bot').remove());
        }
        
        function limpiarBotonesDeAccion() {
            // Limpia solo los botones de acci√≥n (inicio, finalizar, etc.)
            const contenedores = document.querySelectorAll('.botones-accion');
            contenedores.forEach(c => c.closest('.message.bot').remove());
        }

        function agregarMensaje(remitente, contenido, esHTML = false) {
            const msgDiv = document.createElement('div');
            msgDiv.className = `message ${remitente}`;
            const contentDiv = document.createElement('div');
            contentDiv.className = 'content';
            
            if (esHTML) {
                contentDiv.innerHTML = contenido;
            } else {
                contentDiv.textContent = contenido;
            }
            
            msgDiv.appendChild(contentDiv);
            chatBox.appendChild(msgDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
        }
        
        let spinnerElement = null;
        function agregarSpinner(mostrar) {
            if (mostrar) {
                if (!spinnerElement) {
                    spinnerElement = document.createElement('div');
                    spinnerElement.className = 'message bot';
                    spinnerElement.innerHTML = `<div class="content"><div id="spinner"><div class="dot-flashing"></div></div></div>`;
                    chatBox.appendChild(spinnerElement);
                    chatBox.scrollTop = chatBox.scrollHeight;
                }
            } else {
                if (spinnerElement) {
                    spinnerElement.remove();
                    spinnerElement = null;
                }
            }
        }
    </script>
</body>
</html>